<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hive Monitoring Dashboard - Smart Hive Solution</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/style.css?v=2" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="/">Smart Hive Solution</a>
            <div class="ms-auto">
                <span class="navbar-text me-3">
                    <i class="fas fa-clock me-1"></i>
                    <span id="currentTime"></span>
                </span>
                <a class="btn btn-outline-light btn-sm" href="/">
                    <i class="fas fa-home me-1"></i>Dashboard
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- Real-time Status Overview -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-heartbeat me-2"></i>Real-time Hive Health Status
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3" id="hiveStatusCards">
                            <!-- Dynamic status cards will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Sensor Data -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>Live Sensor Data (Last 24 Hours)
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="liveSensorChart" height="300"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-bell me-2"></i>Active Alerts
                        </h5>
                    </div>
                    <div class="card-body" id="activeAlerts">
                        <!-- Dynamic alerts will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Hive Management Actions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-tools me-2"></i>Daily Hive Management Actions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <button class="btn btn-outline-primary w-100 h-100" onclick="scheduleInspection()" title="Schedule hive inspection">
                                    <i class="fas fa-clipboard-check fa-2x mb-2"></i>
                                    <h6>Schedule Inspection</h6>
                                    <small>Plan hive inspections</small>
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-success w-100 h-100" onclick="recordHarvest()" title="Record honey harvest">
                                    <i class="fas fa-jar fa-2x mb-2"></i>
                                    <h6>Record Harvest</h6>
                                    <small>Log honey production</small>
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-info w-100 h-100" onclick="checkWeather()">
                                    <i class="fas fa-cloud-sun fa-2x mb-2"></i>
                                    <h6>Weather Check</h6>
                                    <small>Check conditions</small>
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-warning w-100 h-100" onclick="manageFeeding()">
                                    <i class="fas fa-seedling fa-2x mb-100"></i>
                                    <h6>Feeding Schedule</h6>
                                    <small>Manage bee feeding</small>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hive Performance Metrics -->
        <div class="row">
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-pie me-2"></i>Hive Performance Metrics
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="performanceChart" height="250"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-calendar-alt me-2"></i>Upcoming Tasks
                        </h5>
                    </div>
                    <div class="card-body" id="upcomingTasks">
                        <!-- Dynamic tasks will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inspection Modal -->
    <div class="modal fade" id="inspectionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-clipboard-check me-2"></i>Schedule Hive Inspection
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" title="Close modal"></button>
                </div>
                <div class="modal-body">
                    <form id="inspectionForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Hive ID</label>
                                <select class="form-select" id="inspectionHiveId" required title="Select hive for inspection">
                                    <option value="">Select Hive</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Inspection Type</label>
                                <select class="form-select" id="inspectionType" required title="Select inspection type">
                                    <option value="routine">Routine Check</option>
                                    <option value="health">Health Assessment</option>
                                    <option value="harvest">Pre-Harvest Check</option>
                                    <option value="winter">Winter Preparation</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Scheduled Date</label>
                                <input type="datetime-local" class="form-control" id="inspectionDate" required title="Select inspection date and time">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Priority</label>
                                <select class="form-select" id="inspectionPriority" title="Select priority level">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" id="inspectionNotes" rows="3" placeholder="Any specific observations or concerns..."></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveInspection()">
                        <i class="fas fa-save me-2"></i>Schedule Inspection
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Harvest Modal -->
    <div class="modal fade" id="harvestModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-jar me-2"></i>Record Honey Harvest
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" title="Close modal"></button>
                </div>
                <div class="modal-body">
                    <form id="harvestForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Hive ID</label>
                                <select class="form-select" id="harvestHiveId" required title="Select hive for harvest">
                                    <option value="">Select Hive</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Harvest Date</label>
                                <input type="datetime-local" class="form-control" id="harvestDate" required title="Select harvest date and time">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Honey Weight (kg)</label>
                                <input type="number" step="0.1" class="form-control" id="honeyWeight" required title="Enter honey weight in kilograms">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Honey Type</label>
                                <select class="form-select" id="honeyType" title="Select honey type">
                                    <option value="wildflower">Wildflower</option>
                                    <option value="clover">Clover</option>
                                    <option value="lavender">Lavender</option>
                                    <option value="orange">Orange Blossom</option>
                                    <option value="mixed">Mixed</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Quality Grade</label>
                                <select class="form-select" id="honeyGrade" title="Select honey quality grade">
                                    <option value="premium">Premium</option>
                                    <option value="standard">Standard</option>
                                    <option value="commercial">Commercial</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" id="harvestNotes" rows="3" placeholder="Harvest observations, weather conditions, etc..."></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="saveHarvest()">
                        <i class="fas fa-save me-2"></i>Record Harvest
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // Global variables
    let liveSensorChart;
    let performanceChart;
    let hiveStatusData = {};
    let alertData = [];

    // Initialize the dashboard
    document.addEventListener('DOMContentLoaded', function() {
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);
        
        initializeCharts();
        loadHiveStatus();
        loadActiveAlerts();
        loadUpcomingTasks();
        
        // Auto-refresh every 30 seconds
        setInterval(() => {
            loadHiveStatus();
            loadActiveAlerts();
            updateLiveSensorChart();
        }, 30000);
    });

    function updateCurrentTime() {
        const now = new Date();
        document.getElementById('currentTime').textContent = now.toLocaleString();
    }

    function initializeCharts() {
        // Live Sensor Chart
        const ctx1 = document.getElementById('liveSensorChart').getContext('2d');
        liveSensorChart = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Temperature (°C)',
                        data: [],
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'Humidity (%)',
                        data: [],
                        borderColor: '#0dcaf0',
                        backgroundColor: 'rgba(13, 202, 240, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'Gas Level (ppm)',
                        data: [],
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    }
                }
            }
        });

        // Performance Chart
        const ctx2 = document.getElementById('performanceChart').getContext('2d');
        performanceChart = new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: ['Healthy', 'Warning', 'Critical'],
                datasets: [{
                    data: [0, 0, 0],
                    backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    async function loadHiveStatus() {
        try {
            const response = await fetch('/api/hive/status');
            if (response.ok) {
                const data = await response.json();
                hiveStatusData = data;
                updateHiveStatusCards(data);
                updatePerformanceChart(data);
            }
        } catch (error) {
            console.error('Failed to load hive status:', error);
        }
    }

    function updateHiveStatusCards(data) {
        const container = document.getElementById('hiveStatusCards');
        container.innerHTML = '';

        if (data.hives && data.hives.length > 0) {
            data.hives.forEach(hive => {
                const statusColor = getHiveStatusColor(hive.health_status);
                const statusIcon = getHiveStatusIcon(hive.health_status);
                
                const card = document.createElement('div');
                card.className = 'col-md-3';
                card.innerHTML = `
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body text-center">
                            <div class="mb-3">
                                <i class="${statusIcon} fa-3x text-${statusColor}"></i>
                            </div>
                            <h6 class="card-title">Hive ${hive.hive_id}</h6>
                            <p class="card-text">
                                <small class="text-muted">Temperature: ${hive.temperature || 'N/A'}°C</small><br>
                                <small class="text-muted">Humidity: ${hive.humidity || 'N/A'}%</small><br>
                                <small class="text-muted">Weight: ${hive.hive_weight || 'N/A'}kg</small>
                            </p>
                            <span class="badge bg-${statusColor}">${hive.health_status || 'Unknown'}</span>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        } else {
            container.innerHTML = `
                <div class="col-12 text-center text-muted py-4">
                    <i class="fas fa-bug fa-3x mb-3"></i>
                    <h5>No Hives Found</h5>
                    <p>Register your first hive to start monitoring</p>
                </div>
            `;
        }
    }

    function getHiveStatusColor(status) {
        switch (status) {
            case 'healthy': return 'success';
            case 'warning': return 'warning';
            case 'critical': return 'danger';
            default: return 'secondary';
        }
    }

    function getHiveStatusIcon(status) {
        switch (status) {
            case 'healthy': return 'fas fa-heart';
            case 'warning': return 'fas fa-exclamation-triangle';
            case 'critical': return 'fas fa-exclamation-circle';
            default: return 'fas fa-question-circle';
        }
    }

    function updatePerformanceChart(data) {
        if (data.hives) {
            const healthy = data.hives.filter(h => h.health_status === 'healthy').length;
            const warning = data.hives.filter(h => h.health_status === 'warning').length;
            const critical = data.hives.filter(h => h.health_status === 'critical').length;
            
            performanceChart.data.datasets[0].data = [healthy, warning, critical];
            performanceChart.update();
        }
    }

    async function loadActiveAlerts() {
        try {
            const response = await fetch('/api/alerts');
            if (response.ok) {
                const data = await response.json();
                alertData = data.alerts || [];
                updateActiveAlerts(alertData);
            }
        } catch (error) {
            console.error('Failed to load alerts:', error);
        }
    }

    function updateActiveAlerts(alerts) {
        const container = document.getElementById('activeAlerts');
        container.innerHTML = '';

        const activeAlerts = alerts.filter(alert => !alert.is_resolved);
        
        if (activeAlerts.length === 0) {
            container.innerHTML = `
                <div class="text-center text-success py-3">
                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                    <p class="mb-0">No active alerts</p>
                </div>
            `;
        } else {
            activeAlerts.forEach(alert => {
                const alertElement = document.createElement('div');
                alertElement.className = `alert alert-${getAlertType(alert.type)} alert-dismissible fade show`;
                alertElement.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="fas ${getAlertIcon(alert.type)} me-2"></i>
                        <div class="flex-grow-1">
                            <strong>${alert.title}</strong><br>
                            <small>${alert.message}</small>
                        </div>
                        <small class="text-muted">${getTimeAgo(alert.created_at)}</small>
                    </div>
                `;
                container.appendChild(alertElement);
            });
        }
    }

    function getAlertType(type) {
        switch (type) {
            case 'temperature': return 'danger';
            case 'humidity': return 'warning';
            case 'gas': return 'info';
            case 'battery': return 'secondary';
            default: return 'primary';
        }
    }

    function getAlertIcon(type) {
        switch (type) {
            case 'temperature': return 'fa-thermometer-half';
            case 'humidity': return 'fa-tint';
            case 'gas': return 'fa-wind';
            case 'battery': return 'fa-battery-quarter';
            default: return 'fa-bell';
        }
    }

    function getTimeAgo(timestamp) {
        const now = new Date();
        const time = new Date(timestamp);
        const diff = now - time;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);
        
        if (days > 0) return `${days}d ago`;
        if (hours > 0) return `${hours}h ago`;
        return `${minutes}m ago`;
    }

    async function loadUpcomingTasks() {
        try {
            const response = await fetch('/api/tasks/upcoming');
            if (response.ok) {
                const data = await response.json();
                updateUpcomingTasks(data.tasks || []);
            }
        } catch (error) {
            console.error('Failed to load tasks:', error);
        }
    }

    function updateUpcomingTasks(tasks) {
        const container = document.getElementById('upcomingTasks');
        container.innerHTML = '';

        if (tasks.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-3">
                    <i class="fas fa-calendar-check fa-2x mb-2"></i>
                    <p class="mb-0">No upcoming tasks</p>
                </div>
            `;
        } else {
            tasks.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = 'border-bottom pb-2 mb-2';
                taskElement.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${task.title}</strong><br>
                            <small class="text-muted">${task.description}</small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-${getPriorityColor(task.priority)}">${task.priority}</span><br>
                            <small class="text-muted">${new Date(task.scheduled_date).toLocaleDateString()}</small>
                        </div>
                    </div>
                `;
                container.appendChild(taskElement);
            });
        }
    }

    function getPriorityColor(priority) {
        switch (priority) {
            case 'urgent': return 'danger';
            case 'high': return 'warning';
            case 'medium': return 'primary';
            case 'low': return 'secondary';
            default: return 'secondary';
        }
    }

    async function updateLiveSensorChart() {
        try {
            const response = await fetch('/api/sensor/data/live');
            if (response.ok) {
                const data = await response.json();
                updateChartData(data);
            }
        } catch (error) {
            console.error('Failed to update chart:', error);
        }
    }

    function updateChartData(data) {
        if (data.sensor_data && data.sensor_data.length > 0) {
            const labels = data.sensor_data.map(item => new Date(item.timestamp).toLocaleTimeString());
            const temperatures = data.sensor_data.map(item => item.temperature);
            const humidities = data.sensor_data.map(item => item.humidity);
            const gasLevels = data.sensor_data.map(item => item.gas_level);

            liveSensorChart.data.labels = labels;
            liveSensorChart.data.datasets[0].data = temperatures;
            liveSensorChart.data.datasets[1].data = humidities;
            liveSensorChart.data.datasets[2].data = gasLevels;
            liveSensorChart.update();
        }
    }

    // Modal functions
    function scheduleInspection() {
        loadHiveOptions('inspectionHiveId');
        document.getElementById('inspectionDate').value = new Date().toISOString().slice(0, 16);
        new bootstrap.Modal(document.getElementById('inspectionModal')).show();
    }

    function recordHarvest() {
        loadHiveOptions('harvestHiveId');
        document.getElementById('harvestDate').value = new Date().toISOString().slice(0, 16);
        new bootstrap.Modal(document.getElementById('harvestModal')).show();
    }

    function checkWeather() {
        window.location.href = '/weather.html';
    }

    function manageFeeding() {
        alert('Feeding management feature coming soon!');
    }

    async function loadHiveOptions(selectId) {
        try {
            const response = await fetch('/api/hive/list');
            if (response.ok) {
                const data = await response.json();
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Select Hive</option>';
                
                if (data.hives) {
                    data.hives.forEach(hive => {
                        const option = document.createElement('option');
                        option.value = hive.hive_id;
                        option.textContent = `Hive ${hive.hive_id}`;
                        select.appendChild(option);
                    });
                }
            }
        } catch (error) {
            console.error('Failed to load hives:', error);
        }
    }

    async function saveInspection() {
        const form = document.getElementById('inspectionForm');
        const formData = new FormData(form);
        
        const inspectionData = {
            hive_id: document.getElementById('inspectionHiveId').value,
            type: document.getElementById('inspectionType').value,
            scheduled_date: document.getElementById('inspectionDate').value,
            priority: document.getElementById('inspectionPriority').value,
            notes: document.getElementById('inspectionNotes').value
        };

        try {
            const response = await fetch('/api/inspections', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(inspectionData)
            });

            if (response.ok) {
                alert('Inspection scheduled successfully!');
                bootstrap.Modal.getInstance(document.getElementById('inspectionModal')).hide();
                form.reset();
                loadUpcomingTasks();
            } else {
                alert('Failed to schedule inspection');
            }
        } catch (error) {
            alert('Error scheduling inspection');
        }
    }

    async function saveHarvest() {
        const harvestData = {
            hive_id: document.getElementById('harvestHiveId').value,
            harvest_date: document.getElementById('harvestDate').value,
            honey_weight: parseFloat(document.getElementById('honeyWeight').value),
            honey_type: document.getElementById('honeyType').value,
            honey_grade: document.getElementById('honeyGrade').value,
            notes: document.getElementById('harvestNotes').value
        };

        try {
            const response = await fetch('/api/harvests', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(harvestData)
            });

            if (response.ok) {
                alert('Harvest recorded successfully!');
                bootstrap.Modal.getInstance(document.getElementById('harvestModal')).hide();
                document.getElementById('harvestForm').reset();
            } else {
                alert('Failed to record harvest');
            }
        } catch (error) {
            alert('Error recording harvest');
        }
    }
    </script>
</body>
</html>
