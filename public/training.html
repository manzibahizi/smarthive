<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Training - Smart Hive Solution</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/style.css?v=2" rel="stylesheet">
</head>
<body>
    <div class="wrapper">
        <nav id="sidebar" class="bg-dark text-white">
            <div class="sidebar-header">
                <h3>Smart Hive Solution</h3>
            </div>
            <ul class="list-unstyled components">
                <li>
                    <a href="/" class="nav-link"><i class="fas fa-home"></i> Dashboard</a>
                </li>
                <li>
                    <a href="/hives" class="nav-link"><i class="fas fa-bug"></i> Hive Management</a>
                </li>
                <li>
                    <a href="/weather" class="nav-link"><i class="fas fa-cloud-sun"></i> Weather Data</a>
                </li>
                <li>
                    <a href="/analytics" class="nav-link"><i class="fas fa-chart-line"></i> Analytics</a>
                </li>
                <li>
                    <a href="/settings" class="nav-link"><i class="fas fa-cog"></i> Settings</a>
                </li>
                <li class="active">
                    <a href="/training" class="nav-link"><i class="fas fa-graduation-cap"></i> Training</a>
                </li>
                <li id="adminLink" style="display:none;">
                    <a href="/admin/users" class="nav-link"><i class="fas fa-users-cog"></i> Admin: Users</a>
                </li>
            </ul>
        </nav>
        <div id="content">
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <div class="container-fluid">
                    <button type="button" id="sidebarCollapse" class="btn btn-dark" aria-label="Toggle Sidebar">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="ms-auto"></div>
                </div>
            </nav>
            <div class="container-fluid">
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3 class="mb-0"><i class="fas fa-graduation-cap me-2"></i>Training Resources</h3>
                            <div class="d-flex gap-2">
                                <div id="adminButtons" style="display: none;">
                                    <a href="/admin-training.html" class="btn btn-sm" style="background-color: var(--primary-color); color: white; border-color: var(--primary-color);">
                                        <i class="fas fa-plus me-1"></i>Add Training
                                    </a>
                                    <a href="/admin-tips.html" class="btn btn-success btn-sm">
                                        <i class="fas fa-lightbulb me-1"></i>Add Tips
                                    </a>
                                </div>
                                <div class="input-group" style="max-width: 360px;">
                                    <input id="searchInput" type="search" class="form-control" placeholder="Search training..." aria-label="Search training">
                                    <button id="searchBtn" class="btn btn-outline-secondary" aria-label="Search"><i class="fas fa-search"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-header-orange">
                                    <tr>
                                        <th>Title</th>
                                        <th>Date</th>
                                        <th>Description</th>
                                        <th class="text-end">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="trainingList">
                                    <!-- Training items will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="row mt-4" id="trainingDetailRow" style="display:none;">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body" id="trainingDetail">
                                <!-- Detail content -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Apply Modal -->
    <div class="modal fade" id="applyModal" tabindex="-1" aria-hidden="true" aria-labelledby="applyModalLabel">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="applyModalLabel">Apply for Training</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="applyForm" novalidate>
              <div class="mb-3">
                <label for="applyName" class="form-label">Full name</label>
                <input id="applyName" class="form-control" placeholder="Your full name" required>
                <div class="invalid-feedback">Name is required.</div>
              </div>
              <div class="mb-3">
                <label for="applyPhone" class="form-label">Phone</label>
                <input id="applyPhone" class="form-control" placeholder="Your phone (e.g., +2507XXXXXXXX)" required>
                <div class="invalid-feedback">Valid Rwanda phone is required (+2507XXXXXXXX).</div>
              </div>
              <div class="mb-3">
                <label for="applyEmail" class="form-label">Email (optional)</label>
                <input id="applyEmail" type="email" class="form-control" placeholder="you@example.com">
              </div>
              <div class="mb-3">
                <label for="applyLocation" class="form-label">Location</label>
                <input id="applyLocation" class="form-control" placeholder="District / Sector" required>
                <div class="invalid-feedback">Location is required.</div>
              </div>
              <div class="mb-3">
                <label for="applyExperience" class="form-label">Experience</label>
                <select id="applyExperience" class="form-select" required>
                  <option value="">Select...</option>
                  <option>Beginner</option>
                  <option>Intermediate</option>
                  <option>Advanced</option>
                </select>
                <div class="invalid-feedback">Experience is required.</div>
              </div>
              <div class="mb-3">
                <label for="applyNote" class="form-label">Note (optional)</label>
                <textarea id="applyNote" class="form-control" rows="2" placeholder="Anything we should know"></textarea>
              </div>
              <div id="applyFormStatus" class="mb-2"></div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-success" id="applySubmitBtn">Submit Application</button>
          </div>
        </div>
      </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Sidebar toggle
        document.getElementById('sidebarCollapse').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('active');
        });

        // Show admin link and buttons only for admins
        fetch('/api/auth/me').then(r=>r.json()).then(d=>{
            if(d && d.user && d.user.role === 'admin'){
                const li = document.getElementById('adminLink');
                if(li) li.style.display = '';
                
                const adminButtons = document.getElementById('adminButtons');
                if(adminButtons) adminButtons.style.display = 'flex';
            }
        }).catch(()=>{});

        const listEl = document.getElementById('trainingList');
        const detailRow = document.getElementById('trainingDetailRow');
        const detailEl = document.getElementById('trainingDetail');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');

        let allResources = [];

        function renderList(items){
            listEl.innerHTML = '';
            // Filter to only show published training
            const publishedItems = items.filter(item => item.published === true);
            
            if(!publishedItems || publishedItems.length === 0){
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td colspan="4" class="text-center text-muted py-4">
                        <i class="fas fa-graduation-cap fa-2x mb-2"></i>
                        <br>No training found.
                    </td>`;
                listEl.appendChild(tr);
                return;
            }
            publishedItems.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${item.title}</strong></td>
                    <td><span class="badge bg-info">${item.date || 'No date'}</span></td>
                    <td>${item.description || 'No description'}</td>
                    <td class="text-end"><button class="btn btn-primary btn-sm" data-id="${item.id}">View</button></td>`;
                tr.querySelector('button').addEventListener('click', () => loadDetail(item.id));
                listEl.appendChild(tr);
            });
        }

        function loadList(){
            fetch('/api/training')
                .then(r => r.json())
                .then(d => {
                    const resources = (d && d.training) ? d.training : [];
                    allResources = resources;
                    renderList(resources);
                })
                .catch(() => {
                    listEl.innerHTML = '<div class="col-12 text-danger">Failed to load training resources.</div>';
                });
        }

        function loadDetail(id){
            fetch(`/api/training/${id}`)
                .then(r => r.json())
                .then(d => {
                    const res = d && d.resource ? d.resource : null;
                    if(!res){
                        detailRow.style.display = 'none';
                        return;
                    }
                    const applyCta = `<button id="applyBtn" class="btn btn-success"><i class="fas fa-hand-paper me-1"></i>Apply</button>`;
                    detailEl.innerHTML = `
                        <h4 class="mb-2">${res.title}</h4>
                        <p class="text-muted">ID: ${res.id} ${res.date ? '• ' + res.date : ''}</p>
                        <p>${res.description}</p>
                        <div class="mt-3">${res.published ? applyCta : '<span class="text-muted">Unpublished</span>'}</div>
                        <div id="applyStatus" class="mt-2"></div>
                    `;
                    detailRow.style.display = '';
                    detailRow.scrollIntoView({ behavior: 'smooth' });

                    const btn = document.getElementById('applyBtn');
                    if (btn) {
                        btn.addEventListener('click', () => {
                            // Open modal and bind submit
                            const modalEl = document.getElementById('applyModal');
                            const modal = new bootstrap.Modal(modalEl);
                            const form = document.getElementById('applyForm');
                            const submitBtn = document.getElementById('applySubmitBtn');
                            const formStatus = document.getElementById('applyFormStatus');
                            // Reset form
                            form.reset();
                            form.classList.remove('was-validated');
                            formStatus.textContent = '';
                            modal.show();
                            const onSubmit = () => {
                                form.classList.add('was-validated');
                                const name = document.getElementById('applyName').value.trim();
                                const phone = document.getElementById('applyPhone').value.trim();
                            const email = document.getElementById('applyEmail').value.trim();
                            const location = document.getElementById('applyLocation').value.trim();
                            const experience = document.getElementById('applyExperience').value.trim();
                            const note = document.getElementById('applyNote').value.trim();
                            // basic client validation for Rwanda phone
                            const rwPhone = /^\+2507[2389]\d{7}$/;
                            if (!name || !phone || !location || !experience) { return; }
                            if (!rwPhone.test(phone)) { document.getElementById('applyPhone').classList.add('is-invalid'); return; }
                                submitBtn.disabled = true;
                                formStatus.textContent = 'Submitting...';
                                formStatus.className = 'text-muted';
                            fetch(`/api/training/${res.id}/apply`, { method: 'POST', headers: { 'Content-Type':'application/x-www-form-urlencoded' }, body: new URLSearchParams({ name, phone, email, location, experience, note }) })
                                    .then(async r => { const b = await r.json().catch(()=>({})); if(!r.ok||b.status!=='success') throw new Error(b.message||'Failed');
                                        formStatus.textContent = 'Application submitted'; formStatus.className = 'text-success';
                                        setTimeout(()=>{ modal.hide(); }, 700);
                                    })
                                    .catch(e => { formStatus.textContent = e.message || 'Failed to submit'; formStatus.className = 'text-danger'; })
                                    .finally(()=>{ submitBtn.disabled = false; });
                            };
                            submitBtn.onclick = onSubmit;
                        });
                    }
                })
                .catch(() => {
                    detailEl.innerHTML = '<div class="text-danger">Failed to load training detail.</div>';
                    detailRow.style.display = '';
                });
        }

        function doSearch(){
            const q = (searchInput.value || '').toLowerCase();
            if(!q){
                renderList(allResources);
                return;
            }
            const filtered = allResources.filter(it =>
                (it.title || '').toLowerCase().includes(q) ||
                (it.description || '').toLowerCase().includes(q)
            );
            renderList(filtered);
        }

        searchBtn.addEventListener('click', doSearch);
        searchInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') doSearch(); });

        loadList();
    });
    </script>
</body>
</html>


